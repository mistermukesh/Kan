<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Verification</title>
    <style>
        /* [Keep all your existing CSS styles] */
        /* ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Location Verification</h1>
        <p>We need to verify your installation location</p>
        
        <div class="spinner-container" id="spinnerContainer">
            <div class="spinner"></div>
            <div class="spinner-inner"></div>
        </div>
        
        <div id="status" class="status-message"></div>
        
        <button id="verifyBtn" class="btn">Verify Location</button>
        <button id="continueBtn" class="btn" style="display: none; background-color: #2ecc71;">Continue to Form</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('status');
            const verifyBtn = document.getElementById('verifyBtn');
            const continueBtn = document.getElementById('continueBtn');
            const spinnerContainer = document.getElementById('spinnerContainer');
            
            // Google Apps Script Web App URL
            const scriptUrl = 'https://script.google.com/a/macros/kanuniversal.com/s/AKfycbxT1e03Z8E-mON3ciLBZRZg1KmOXS5vR2AAC45gUFfp-KbiWTll8wlgyCfrEuKrzSZsEg/exec';
            
            // Final redirect URL
            const formUrl = 'https://forms.gle/1RCb9k7pphSPzY7j6';
            
            verifyBtn.addEventListener('click', function() {
                // Show spinner
                spinnerContainer.style.display = 'block';
                verifyBtn.style.display = 'none';
                statusElement.textContent = '';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            try {
                                // Send data to Google Apps Script
                                const response = await sendLocationToGoogleScript(
                                    position.coords.latitude, 
                                    position.coords.longitude
                                );
                                
                                if (response.status === "success") {
                                    showStatus("✓ Location verified successfully!", "success");
                                    continueBtn.style.display = 'block';
                                    spinnerContainer.style.display = 'none';
                                } else {
                                    throw new Error(response.message);
                                }
                            } catch (error) {
                                showStatus("⚠ " + error.message, "error");
                                continueBtn.style.display = 'block';
                                spinnerContainer.style.display = 'none';
                            }
                        },
                        function(error) {
                            let errorMessage = "Couldn't verify location: ";
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += "Permission was denied.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += "Location unavailable.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += "Request timed out.";
                                    break;
                                default:
                                    errorMessage += "Unknown error occurred.";
                            }
                            showStatus("⚠ " + errorMessage, "error");
                            continueBtn.style.display = 'block';
                            spinnerContainer.style.display = 'none';
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 0
                        }
                    );
                } else {
                    showStatus("⚠ Browser doesn't support location services", "error");
                    continueBtn.style.display = 'block';
                    spinnerContainer.style.display = 'none';
                }
            });
            
            continueBtn.addEventListener('click', function() {
                window.location.href = formUrl;
            });
            
            function showStatus(message, type) {
                statusElement.textContent = message;
                statusElement.className = 'status-message ' + type;
                statusElement.style.opacity = '1';
                statusElement.style.transform = 'translateY(0)';
            }
            
            async function sendLocationToGoogleScript(lat, lng) {
                const formData = new FormData();
                formData.append('latitude', lat);
                formData.append('longitude', lng);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow'
                });
                
                return await response.json();
            }
        });
    </script>
</body>
</html>
